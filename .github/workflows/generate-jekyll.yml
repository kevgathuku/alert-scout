name: Generate Jekyll Posts

on:
  # Run daily at 3am UTC to consolidate previous day's alerts
  schedule:
    - cron: "0 3 * * *" # Daily at 3am UTC

  # Allow manual trigger with optional specific date
  workflow_dispatch:
    inputs:
      date:
        description: 'Date to generate post for (YYYY-MM-DD, defaults to yesterday)'
        required: false
        type: string
      run_id:
        description: 'Specific workflow run ID to download artifacts from (for debugging)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  generate-jekyll:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Set up Clojure
        uses: DeLaGuardo/setup-clojure@13.4
        with:
          lein: latest

      - name: Cache Leiningen dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2
            ~/.lein
          key: ${{ runner.os }}-lein-${{ hashFiles('project.clj') }}
          restore-keys: |
            ${{ runner.os }}-lein-

      # Checkout alerts-data branch to get all accumulated alerts
      - name: Checkout alerts data
        uses: actions/checkout@v4
        with:
          ref: alerts-data
          path: alerts-data

      - name: Copy alerts to content directory
        run: |
          if [ -d "alerts-data/content" ]; then
            cp -r alerts-data/content .
            echo "Copied alerts data:"
            ls -laR content/
          else
            echo "No alerts data found"
          fi

      - name: Generate Jekyll post
        run: |
          # Use provided date or default to yesterday
          DATE="${{ github.event.inputs.date }}"
          if [ -z "$DATE" ]; then
            # Get yesterday's date
            DATE=$(date -d "yesterday" '+%Y-%m-%d')
          fi
          echo "Generating Jekyll post for $DATE"
          echo "POST_DATE=$DATE" >> $GITHUB_ENV
          lein generate-jekyll $DATE

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-checkout

      - name: Copy generated post to gh-pages
        run: |
          cp blog/_posts/*.markdown gh-pages-checkout/blog/_posts/

      - name: Commit and push Jekyll post
        working-directory: gh-pages-checkout
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add blog/_posts/*.markdown
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: Add alert report for ${{ env.POST_DATE }}"
            git push
            echo "Successfully pushed to gh-pages"
          fi
